# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
variables:
  CONTAINER_REGISTRY: ""

stages:
- build

before_script:
  - echo "start java archive~!!"

dockerfile:
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
    DOCKER_USER: angelinurs
    DOCKER_PASSWORD: "@@rhdrhd12546"
    VERSION: "0.9"
  image: docker:git
  services:
    - docker:dind
  stage: build
  before_script:
    - echo "build Dockerfile"
    - export DOCKERFILE_NAME=`echo "$CI_PROJECT_NAME" | cut -d '-' -f 2`
    # in private docker hub registry, repository name must be lower case.
    - echo $DOCKERFILE_NAME | sed 's/[A-Z]/L&/g' >> DOCKERFILE_NAME
    - echo $DOCKERFILE_NAME
    # in private docker hub registry, CONTAINER_REGISTRY is user id
    - export CONTAINER_REGISTRY=`echo $DOCKER_USER`
    - echo $DOCKER_PASSWORD | docker login --username $DOCKER_USER --password-stdin
  script: 
    - docker build -t $DOCKERFILE_NAME:$VERSION ./dockerfile
    - docker image tag $DOCKERFILE_NAME:$VERSION $CONTAINER_REGISTRY/$DOCKERFILE_NAME:$VERSION
    - docker push $CONTAINER_REGISTRY/$DOCKERFILE_NAME:$VERSION
    # clear &&
    - docker images | grep $DOCKERFILE_NAME
    - docker system prune -f -a